# FileStorage - загрузка и хранение файлов.

Компонент позволяющий загружать и хранить файлы, генерировать thumbnails изображений. 

####Подробнее: 
- resize изображения;
- конвертирование в разные расширения;
- наложение водяных меток;
- генерирование thumbnails с различными настройками.

##Установка

1) Чтобы установить компонент, нужно в composer.jsom добавить следующие строки: 
```
"require": {
    "chulakov/yii2-filestorage": "dev-master"
},
...
"repositories": [
    {
        "type": "vcs",
        "url":  "git@bitbucket.org:OlegChulakovStudio/yii2-filestorage.git
    }
]
```

2) Выполнить в корне проекта следующую команду, чтобы обновить зависимости проекта и подгрузить компонент: 
```
composer update
```

##Настройка

1) Подключение компонента хранилища. 

В `config/main.php` нужно подключить компонент, он понадобится для сохранения файлов. 
Подключение выглядит так: 
```
        'fileStorage' => [
            'class' => \chulakov\filestorage\FileStorage::className(),
            'storageBaseUrl' => false,
            'storagePath' => '@webroot', // путь сохранения
            'storageDir' => 'uploaded',  //  папка с сохраняемыми файлами
        ],
```
2) Подключение модели отношения.

Система сохранения работает с помощью отношений, они ответственны за доставку файла модели.
Данные отношения прикрепляются к моделям, в дальнейшем обрабатывают файл и прикрепляют файл в указанный атрибут модели. 

####Имеется два отношения: 
- `FileUploadBehavior` - отношение расчитано на загрузку одного файла;
- `FilesUploadBehavior` - отношение расчитано на загрузку нескольких файлов. 

Отношения подключаются так: 
```
 public function behaviors()
    {
        return [
            [
                'class' => FileUploadBehavior::className(), // отношение
                'attribute' => 'image', // атрибут модели
                'group' => 'photos', // сохраняемая группа
                'storage' => 'fileStorage', // компонент хранения файлов 
                'repository' => UploadedFile::class, // репозиторий
            ],
        ];
    }
```
3) Подключение репозиториев.

К каждому отношению нужно настроить способ получения файла, а именно - настроить репозиторий. 

Всего имеется два репозитория для обычной и удаленной загрузки.

####Репозитории: 
- `UploadedFile` - загрузка обычных файлов(через POST запрос);
- `RemoteUploadedFile` - загрузка удаленных файлов(через ссылку на файл).

4) Настройка репозиториев.

Сам репозиторий основан на паттерне Observer, то бишь он имеет слушателя и наблюдателя.

####В данном случае: 
- `UploadedFile` - наблюдатель;
- `ImageManager` - слушатель.

В конечном итоге, весь компонент работает на событийной модели обработки и сохранения файлов. 

Реализуется такая цепочка:
получаем файл -> срабатывает событие -> производится обработка файла -> сохранение файла.

5) Настройка слушателей.

Слушатели подписываются на события наблюдателя, после чего каждый слушатель получает информацию о файле в момент сохранения файла. Каждый слушатель может производить над файлом свои действия, в результате чего производится видоизменение файла и различные побочные дейтсвия.

Все слушатели должны реализовывать `ListenerInterface`, только так они могут подписаться на наблюдателя.

В компоненте реализован базовый слушатель `ImageManager`. Он работает с только изображениями, производит resize, накладывает watermark, меняет расширение м т.д. Он имеет следующие настройки: 

- `width` - ширина изображения;
- `height` - высота изображения;
- `encode` - расширение изображения;
- `quality` - качество изображения;
- `watermark` - путь на водяную метку;
- `watermarkPosition` - позиция водяной метки;
- `imageClass` - компонент работы с изображениями.

Каждая настройка применяется над файлом, после сохранения все данные настройки будут отображены на конечном сохраненном файле.

Настройки имеют такой вид: 
```
    public function behaviors()
    {
        return [
            [
                'class' => FileUploadBehavior::className(), // подключаемое отношение
                'attribute' => 'image', // атрибут, в которое будет помещен файл
                'group' => 'photos', // группа сохраняемого изображения
                'storage' => 'fileStorage', // компонент хранения
                'repository' => UploadedFile::class, // выбранный загрузчик
                'repositoryOptions' => [ // опции репозитория
                    'listeners' => // список слушателей
                        [
                            [
                                'class' => ImageManager::className(), // класс слушателя
                                'width' => 640, // ширина
                                'height' => 480, // высота
                                'encode' => 'jpg', // расширение
                                'quality' => 100, // качество в процентах
                                'watermarkPath' => '/path_to_image/watermark.png', // наложенная водяная метка
                                'watermarkPosition' => ImageComponent::POSITION_CENTER, // позиция водяной метки
                                'imageClass' => ImageComponent::className() // класс работы с изображениями
                                'accessRole' => 'role_example', // роль разрешенная для работы с изображениями
                            ]
                        ],
                ]
            ],
        ];
    }
```
